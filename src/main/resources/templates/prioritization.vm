<!--
Written by Veniture

TODO
İssue Link olsun
-->
$webResourceManager.requireResources("com.veniture.PortfolioManagement:PortfolioManagement-resources")


<!--
Created using JS Bin
http://jsbin.com

Copyright (c) 2019 by venITure

Released under the MIT license: http://jsbin.mit-license.org
-->
<html>
<head>
    <!-- Latest compiled and minified CSS-->

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/table-to-json@0.13.0/lib/jquery.tabletojson.min.js" integrity="sha256-AqDz23QC5g2yyhRaZcEGhMMZwQnp8fC6sCZpf+e7pnw=" crossorigin="anonymous"></script>
    <script src="https://raw.githack.com/SortableJS/Sortable/master/Sortable.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <link rel="stylesheet" href="aui/aui-prototyping.css" media="all"/>
    <script src="aui/aui-prototyping.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.22/datatables.min.css"/>

    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.22/datatables.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/table-to-json@1.0.0/lib/jquery.tabletojson.min.js" integrity="sha256-H8xrCe0tZFi/C2CgxkmiGksqVaxhW0PFcUKZJZo1yNU=" crossorigin="anonymous"></script>

##    <script type="text/javascript" src="../js/jquery.ganttChart.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>


    <meta charset="utf-8">
    <title>Proje Önceliklendirme</title>

    <meta name="decorator" content="atl.general">

    <style>
        .blink {
            animation: blinker 2s linear infinite;
            color: #bf2600;
            font-size: 18px;
            font-weight: bold;
            font-family: sans-serif;
        }
        @keyframes blinker {
            50% { opacity: 0; }
        }
        #content {
            margin: 12px;
        }

        #tableBody>tr {
            cursor: grab;
        }
        #tableBody>tr :active {
            cursor: grabbing;
        }

        #loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .might-overflow {
            text-overflow: ellipsis;
            overflow : hidden;
            white-space: nowrap;
        }

        .might-overflow:hover {
            text-overflow: clip;
            white-space: normal;
            word-break: break-all;
        }

        #loading-spinner aui-spinner {
            margin: 1em;
        }

        .custom-card-style {
            border-radius: 3px;
            box-shadow:
                    0 1px 1px rgba(9, 30, 66, 0.25),
                    0 0 1px 0 rgba(9, 30, 66, 0.31);
            margin: 0 auto;
            padding: 10px;
            width: 20em;
        }

        td {
            min-width:15px;
            max-width:100px;
        }
        #row1{
            font-weight: bold;
            text-align: left;
            font-size: 13px;
        }
        #shadow:hover {
            background-color: #f5f5f5;
            padding: 10px;
        }
        .aui-help-content{
            margin-bottom: 60px;
        }
        .row{
            margin-bottom: 10px;
        }
        #buttons{
            text-align: center;
            margin-left:auto;
        }
        #auiTable{
            margin-left: auto;
            margin-right: auto;
            position: center;
            margin-bottom: 130px;
            border-collapse: separate;
            border-spacing: 0 10px;
            width: 100%;
        }
        #auiTable td, #auiTable tr{
            border: 1px solid #ddd;
        }
        /*#auiTable tr:nth-child(even){background-color: #f2f2f2;}*/

        /*table.dataTable tbody tr.selected {*/
        /*    color: #6dc4e7;*/
        /*}*/

        #auiTable tr:hover {background-color: #ddd;}

        #auiTable th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #0747a6;
            color: #deebff;
        }
        table.dataTable.no-footer {
            border-bottom: none;
        }
        table.dataTable thead th, table.dataTable thead td {
            border-bottom: none;
        }

        .dataTables_wrapper .dataTables_filter {
            float: left;
        }

        .dataTables_wrapper .dataTables_filter input {
            font-weight: normal;
        }

        label {
            color: #6b778c;
        }


    </style>

    <script>
        // create
        AJS.$(document).ready(function () {
            window.onbeforeunload = null;

            var filterAndIssueKeys = [];
            var defaultIssueList = [];

            var sortable = new Sortable(tableBody, {
                scroll: true,
                scrollSensitivity: 130,
                scrollSpeed: 28,
                handle: 'tr',
                sort: true,
                animation: 150,
                store: {
                    get: function () {
                        var list = []
                        #foreach($pri in $priorityList)
                            list.push($pri)
                        #end
                        return list;
                    }
                },
                onUpdate: function (evt) {
                    updatePriorities("$restriction");
                }
            });

            #foreach($issue in $issueList)
                defaultIssueList.push("$issue.getKey()")
            #end

            var tableIndex = -1;
            $("#auiTable tr").each(function () {
                var issuePriority = $(this).find("td").eq(3);
                var priIndex = 0;
                #foreach($pri in $priorityList)
                    if (priIndex == tableIndex) {
                        var priInt = parseInt("$pri")
                        issuePriority.html(priInt)
                    }
                    priIndex += 1;
                #end
                tableIndex += 1
            })

            var hiddenColumns = []
            var i;
            for (i=4; i<4+parseInt("$customFieldsInProject.size()"); i++){
                hiddenColumns.push(i);
            }

            /* def of DataTable */
            var dataTable = $("#auiTable").DataTable({
                order: [[ 3, "asc" ]],
                bLengthChange: false,
                bPaginate: false,
                bInfo: false,
                bAutoWidth: false,
                bFilter: false,
                pageLength: parseInt($issueList.size()),
                columnDefs: [
                    {
                        "targets": hiddenColumns,
                        "visible": false
                    }
                ]
            });

            var tempDataTable = $('#auiTable').tableToJSON();
            var jsonDataTable = $('#auiTable').tableToJSON();


            var butceCount = 0;
            var selectedButce = JSON.parse(JSON.stringify(butceCount))
            var selectedRows = []
            var baslangicTarihiBoolean = true;
            var bitisTarihiBoolean = true;
            var selectedThisRows = []
            var issueAndDates = []

            $('#auiTable tbody').on( 'click', 'tr', function () {
                $(this).toggleClass('selected');
                selectedThisRows.push($(this))
                var selectKey = $(this).children().first().children().text();
                var baslangicKisit = $("#baslangicTarihiInput").val();
                var bitisKisit = $("#bitisTarihiInput").val();
                var baslangicKisitDate = Date.parse(baslangicKisit);
                var bitisKisitDate = Date.parse(bitisKisit);

                if (!selectedRows.includes(selectKey)) {
                    for (var i = 0; i < jsonDataTable.length; i++) {
                        if (jsonDataTable[i]['key'] === selectKey) {
                            if (isNaN(parseInt(jsonDataTable[i]['Bütçe']))) {
                                butceCount = selectedButce
                                alert("Lütfen Bütçe Alanını ekleyin")
                                $(this).removeClass('selected');

                            } else {
                                if (Object.keys(jsonDataTable[i]).includes("Başlangıç Tarihi")  ) {
                                    if (jsonDataTable[i]["Başlangıç Tarihi"] !== "-") {
                                        var issueBaslangicTarihiString = jsonDataTable[i]["Başlangıç Tarihi"];
                                        issueBaslangicTarihiString = issueBaslangicTarihiString.replaceAll("-", "/")
                                        issueBaslangicTarihiString = issueBaslangicTarihiString.replaceAll(".0", "")
                                        var issueBaslangicTarihiDate = Date.parse(issueBaslangicTarihiString);

                                        if(!isNaN(baslangicKisitDate)){
                                            if (issueBaslangicTarihiDate >= baslangicKisitDate) {
                                            } else {
                                                baslangicTarihiBoolean = false;
                                            }
                                        }
                                    }
                                }
                                if (Object.keys(jsonDataTable[i]).includes("Bitiş Tarihi")  ) {
                                    if (jsonDataTable[i]["Bitiş Tarihi"] !== "-") {
                                        var issueBitisTarihiString = jsonDataTable[i]["Bitiş Tarihi"];
                                        issueBitisTarihiString = issueBitisTarihiString.replaceAll("-", "/")
                                        issueBitisTarihiString = issueBitisTarihiString.replaceAll(".0", "")
                                        var issueBitisTarihiDate = Date.parse(issueBitisTarihiString);

                                        if(!isNaN(bitisKisitDate)){
                                            if (issueBitisTarihiDate < bitisKisitDate) {
                                            } else {
                                                bitisTarihiBoolean = false;
                                            }
                                        }
                                    }
                                }


                                butceCount += parseInt(jsonDataTable[i]['Bütçe'])
                                selectedButce = butceCount
                                selectedRows.push(selectKey)
                            }
                        }
                    }
                    if (baslangicTarihiBoolean){
                        if (bitisTarihiBoolean) {
                            $("#issueDurum").text("Olumlu");
                            $("#issueDurum").css("color", "green")
                        }
                        else {
                            $("#issueDurum").text("Olumsuz(Bitiş Tarihi Geçersiz)");
                            $("#issueDurum").css("color", "red")
                        }
                    }
                    else {
                        $("#issueDurum").text("Olumsuz(Başlangıç Tarihi Geçersiz)");
                        $("#issueDurum").css("color", "red")
                    }

                }
                else {
                    var deselectIndex = selectedRows.indexOf(selectKey);
                    if (deselectIndex > -1) {
                        selectedRows.splice(deselectIndex, 1);

                    }
                    for (var i = 0; i < jsonDataTable.length; i++) {
                        if (jsonDataTable[i]['key'] === selectKey) {

                            butceCount -= parseInt(jsonDataTable[i]['Bütçe'])
                            selectedButce = butceCount
                        }
                    }
                }
                $("#butceMiktari").text(butceCount)


                var butceKisit = $("#butceInput").val();

                if (parseInt(butceCount) <= parseInt(butceKisit)){
                    $("#butceMiktari").removeClass("blink")
                    $("#butceMiktari").css("color","green")
                    $("#butceMiktari").css("font-weight","bold")

                }else if(parseInt(butceCount) > parseInt(butceKisit)){
                    $("#butceMiktari").css("color","red")
                    $("#butceMiktari").toggleClass("blink")
                }else{
                    $("#butceMiktari").removeClass("blink")
                    $("#butceMiktari").css("color","black")
                }

            } );


            updatePriorities("$restriction");

            AJS.$("#customFieldList-select2").auiSelect2();
            AJS.$("#favFilter-select2").auiSelect2();
            AJS.$("#constraintList-select2").auiSelect2();
            AJS.$("#baslangicTarihiInput").datePicker({
                overrideBrowserDefault:true,
                dateFormat: "yy-mm-dd",
                inline:true,
                autoclose: true,
                onSelect: function (date) {
                    //datePickerChanged(date)
                    datePickerFilter(date)
                }
            })
            AJS.$("#bitisTarihiInput").datePicker({
                overrideBrowserDefault:true,
                dateFormat: "yy-mm-dd",
                inline:true,
                autoclose: true,
                onSelect: function (date) {
                    //datePickerChanged(date)
                    datePickerFilter(date)
                }
            })

            var issueKeys =[];
            jsonDataTable.forEach(cell => {
                issueKeys.push(cell.key)
            })


            var baslangicTarihiCFvalues = bulkGetCfValuesFromIssue(issueKeys.join(","), "customfield_11102");
            var bitisTarihiCFvalues = bulkGetCfValuesFromIssue(issueKeys.join(","), "customfield_10900");

            var baslangicTarihiArray = baslangicTarihiCFvalues.split(",,,");
            var bitisTarihiArray = bitisTarihiCFvalues.split(",,,");
            console.log("baslangicTarihiArray: ", baslangicTarihiArray)
            console.log("bitisTarihiArray: ", bitisTarihiArray)

            google.charts.load('current', {'packages':['gantt']});
            google.charts.setOnLoadCallback(drawChart);

            function drawChart() {

                var data = new google.visualization.DataTable();
                data.addColumn('string', 'Task ID');
                data.addColumn('string', 'Task Name');
                data.addColumn('string', 'Issue Key');
                data.addColumn('date', 'Start Date');
                data.addColumn('date', 'End Date');
                data.addColumn('number', 'Duration');
                data.addColumn('number', 'Percent Complete');
                data.addColumn('string', 'Dependencies');

                console.log("jsonDataTable: ", jsonDataTable)

                var baslangicDate, bitisDate;
                var ganttRows = []
                var ganttRow = []
                var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };

                for (var i=0; i<jsonDataTable.length; i++){
                    var jsonRow = jsonDataTable[i];
                    if (baslangicTarihiArray[i] !== "-"){
                        baslangicTarihiArray[i] = baslangicTarihiArray[i].replaceAll("-", "/")
                        baslangicTarihiArray[i] = baslangicTarihiArray[i].replaceAll(".0", "")
                        baslangicDate = new Date(baslangicTarihiArray[i])
                        baslangicDate = new Date(baslangicDate.getFullYear(), baslangicDate.getMonth(), baslangicDate.getDate())
                    }
                    if (baslangicTarihiArray[i] === "-") {
                        baslangicDate = new Date(2020, 10, 1+Math.floor(Math.random() * 10))
                        baslangicDate = new Date(baslangicDate.getFullYear(), baslangicDate.getMonth(), baslangicDate.getDate())
                    }
                    if (bitisTarihiArray[i] !== "-"){
                        bitisTarihiArray[i] = bitisTarihiArray[i].replaceAll("-", "/")
                        bitisTarihiArray[i] = bitisTarihiArray[i].replaceAll(".0", "")
                        bitisDate = new Date(bitisTarihiArray[i])
                        bitisDate = new Date(bitisDate.getFullYear(), bitisDate.getMonth(), bitisDate.getDate())
                    }
                    if (bitisTarihiArray[i] === "-") {
                        bitisDate = new Date(2020, 10, 11+Math.floor(Math.random() * 19))
                        bitisDate = new Date(bitisDate.getFullYear(), bitisDate.getMonth(), bitisDate.getDate())
                    }
                    console.log(jsonRow['key'], baslangicDate, bitisDate)
                    ganttRow = [jsonRow['key'], jsonRow['key'], jsonRow['key'], baslangicDate, bitisDate, null, 100, null]
                    ganttRows.push(ganttRow)
                }
                data.addRows(ganttRows)
                // data.addRows([
                //     ['Spring 2014', 'Spring 2014', 'Spring 2014',
                //         new Date(2014, 2, 22), new Date(2014, 5, 20), null, 100, null],
                //     ['Summer 2014', 'Summer 2014', 'Summer 2014',
                //         new Date(2014, 5, 21), new Date(2014, 8, 20), null, 100, null],
                //     ['Autumn 2014', 'Autumn 2014', 'Autumn 2014',
                //         new Date(2014, 8, 21), new Date(2014, 11, 20), null, 100, null],
                //     ['Winter 2014', 'Winter 2014', 'Winter 2014',
                //         new Date(2014, 11, 21), new Date(2015, 2, 21), null, 100, null],
                //     ['Spring 2015', 'Spring 2015', 'Spring 2015',
                //         new Date(2015, 2, 22), new Date(2015, 5, 20), null, 100, null]
                // ]);

                var options = {
                    height: 400,
                    gantt: {
                        trackHeight: 30
                    }
                };

                var chart = new google.visualization.Gantt(document.getElementById('gantt'));

                chart.draw(data, options);
            }
            // var gant = $("#gantt")
            // console.log("gantttt:", gant)
            // AJS.$('#gantt').gantt({
            //     source: demoSource,
            //     navigate: "scroll",
            //     scale: "weeks",
            //     maxScale: "months",
            //     minScale: "hours",
            //     itemsPerPage: 10,
            //     scrollToToday: false,
            //     useCookie: true,
            //     onItemClick: function(data) {
            //         alert("Item clicked - show some details");
            //     },
            //     onAddClick: function(dt, rowId) {
            //         alert("Empty space clicked - add an item!");
            //     },
            //     onRender: function() {
            //         if (window.console && typeof console.log === "function") {
            //             console.log("chart rendered");
            //         }
            //     }
            // });
            // AJS.$("#gantt").popover({
            //     selector: ".bar",
            //     title: function _getItemText() {
            //         return this.textContent;
            //     },
            //     container: '.gantt',
            //     content: "Here's some useful information.",
            //     trigger: "hover",
            //     placement: "auto right"
            // });

            AJS.$('#kaydetButton').off().on("click", function (e) {
                var params = new window.URLSearchParams(window.location.search);
                updatePrioritiesInJIRA(params.get('restriction'));
                e.preventDefault();
            });
            AJS.$("#loading-spinner").hide();
            AJS.$("#customFieldList-select2").on('select2-selecting', function (e) {
                //Header'ı göster
                AJS.$('#auiTable > thead  th[data-override*="'+e.val+'"]').show();

                var issueKeys =[];
                jsonDataTable.forEach(cell => {
                    issueKeys.push(cell.key)
                })

                var cfValues = bulkGetCfValuesFromIssue(issueKeys.join(","), e.val);
                console.log("eee: ", e.val)

                var index;
                dataTable.columns()[0].forEach(innerIndex => {
                    if (dataTable.column(innerIndex).header().textContent === e.object.text) {
                        index = innerIndex
                    }
                })
                var array = cfValues.split(",,,");

                dataTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
                    var rowData = this.data();
                    rowData[index] = array[rowLoop]
                    dataTable.row(rowIdx).data(rowData)
                    jsonDataTable[rowLoop][e.object.text] = array[rowLoop]
                    this.invalidate()
                });
                dataTable.draw()

                dataTable.column(index).visible(true)
                dataTable.columns.adjust().draw(true);
            });
            AJS.$("#customFieldList-select2").on("select2-removing", function(e) {
                fieldNames = []
                dataTable.settings().columns()[0].forEach(function(index) {
                    fieldNames.push($(dataTable.column(index).header()).text())
                })
                var index;
                // dataTable.columns()[0].forEach(innerIndex => {
                dataTable.rows().every( function ( rowIdx, tableLoop, innerIndex ) {
                    delete jsonDataTable[innerIndex][e.choice.text]
                })
                dataTable.columns()[0].forEach(innerIndex => {
                    if (dataTable.column(innerIndex).header().textContent === e.choice.text){
                        index = innerIndex
                    }
                })

                dataTable.column(index).visible(false)
            });

            var k;
            AJS.$("#favFilter-select2").on("select2-removing", function(e) {
                filterAndIssueKeys.forEach(filterAndIssueKey => {
                    if (filterAndIssueKey.filterName ===  e.choice.text ){
                        jsonDataTable.forEach(data => {
                            if (!filterAndIssueKey.issueKeys.includes(data.key)) {
                                var rowArray = []
                                rowArray.push('<a href="$baseUrl/browse/' + data.key + '" ' + 'class="issueKey">' + data.key + '</a>');
                                rowArray.push(data.Summary)
                                rowArray.push(data.Description)
                                rowArray.push(data.Priority)
                                #foreach($cf in $customFieldsInProject)
                                    rowArray.push('<td id="$cf.getId()" name="$cf.getId()"  style="display:none;" class="$cf.getId()">-</td>')
                                #end
                                dataTable.row.add(rowArray).draw(true)
                            }
                        } );
                    }
                })
            });
            var beforeSelectedOption = ""
            AJS.$("#favFilter-select2").on('select2-selecting', function (e) {
                var data = e.object.text;

                if (e.object.text === "Bir seçenek seçin"){
                    if (beforeSelectedOption !== "Bir seçenek seçin") {
                        filterAndIssueKeys.forEach(filterAndIssueKey => {
                            if (filterAndIssueKey.filterName === beforeSelectedOption) {
                                jsonDataTable.forEach(data => {
                                    if (!filterAndIssueKey.issueKeys.includes(data.key)) {
                                        var rowArray = []
                                        rowArray.push('<a href="$baseUrl/browse/' + data.key + '" ' + 'class="issueKey">' + data.key + '</a>');
                                        rowArray.push(data.Summary)
                                        rowArray.push(data.Description)
                                        rowArray.push(data.Priority)
                                        #foreach($cf in $customFieldsInProject)
                                            rowArray.push('<td id="$cf.getId()" name="$cf.getId()"  style="display:none;" class="$cf.getId()">'+ data["$cf.getName()"] +'</td>')
                                        #end
                                        dataTable.row.add(rowArray).draw(true)
                                    }
                                });
                            }
                        })
                        beforeSelectedOption = "Bir seçenek seçin"
                    }
                }
                else {
                    beforeSelectedOption = e.object.text
                    jQuery.ajax({
                        url: AJS.params.baseURL + "/rest/florestservice/1.2/rest/favFilterJQL",
                        type: 'POST',
                        data: {
                            jqlQuery: e.object.text
                        },
                        async: false,
                        success: function (response, status, jqXHR) {
                            var filterBoolean = false;
                            filterAndIssueKeys.forEach(filterAndIssueKey => {
                                if (filterAndIssueKey.filterName === data)
                                    filterBoolean = true
                            })
                            if (!filterBoolean) {
                                filterAndIssueKeys.push({
                                    "filterName": data,
                                    "issueKeys": response
                                })
                            }
                            var j;
                            var tableBody = $('#tableBody tr');

                            var partialKeys = []
                            dataTable.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
                                var rowData = this.data();
                                var subStringRowData = rowData[0].substring(0, rowData[0].length-1)
                                var lastIndexSlash = subStringRowData.lastIndexOf(">");
                                var lastIndexBackSlash = subStringRowData.lastIndexOf("<")
                                var partialKey = subStringRowData.substring(lastIndexSlash+1, lastIndexBackSlash)
                                partialKeys.push(partialKey)
                            } );

                            response.forEach(responseKey => {
                                if (!partialKeys.includes(responseKey)){
                                    jsonDataTable.forEach(data => {
                                        if (data.key === responseKey){
                                            var rowArray = []
                                            rowArray.push('<a href="$baseUrl/browse/' + data.key + '" ' + 'class="issueKey">' + data.key + '</a>');
                                            rowArray.push(data.Summary)
                                            rowArray.push(data.Description)
                                            rowArray.push(data.Priority)
                                            // rowArray.push(data.Created)
                                            // rowArray.push(data.Due)
                                            #foreach($cf in $customFieldsInProject)
                                                rowArray.push('<td id="$cf.getId()" name="$cf.getId()"  style="display:none;" class="$cf.getId()">'+ data["$cf.getName()"] +'</td>')
                                            #end
                                            dataTable.row.add(rowArray).draw(true)
                                        }
                                    })
                                }
                            })
                            tableBody.each(function () {
                                var cell = $(this)
                                var issueKey = $(this).find("td .issueKey")
                                var deleteBoolean = true;
                                for (j = 0; j < response.length; j++) {
                                    if (response[j] === issueKey.text()) {
                                        deleteBoolean = false;
                                    } else {
                                    }
                                }
                                if (deleteBoolean) {
                                    dataTable.row(cell).remove().draw();
                                }
                            })

                            partialKeys = []
                            dataTable.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
                                var rowData = this.data();
                                var subStringRowData = rowData[0].substring(0, rowData[0].length-1)
                                var lastIndexSlash = subStringRowData.lastIndexOf(">");
                                var lastIndexBackSlash = subStringRowData.lastIndexOf("<")
                                var partialKey = subStringRowData.substring(lastIndexSlash+1, lastIndexBackSlash)
                                partialKeys.push(partialKey)
                            } );
                        },
                        error: function (response) {
                            console.log("errorjql: ", response)
                        }
                    })
                }
            });

            AJS.$("#constraintList-select2").on('select2-selecting', function (e) {
                if (e.object.text === "Bütçe"){
                    $("#butceInput").css("visibility", "visible");
                    $("#butceLabel").css("visibility", "visible");
                }
                else if (e.object.text === "Başlangıç Tarihi"){
                    $("#baslangicTarihiInput").css("visibility", "visible");
                    $("#baslangicTarihiLabel").css("visibility", "visible");
                }
                else if (e.object.text === "Bitiş Tarihi"){
                    $("#bitisTarihiInput").css("visibility", "visible");
                    $("#bitisTarihiLabel").css("visibility", "visible");
                }
            });

            AJS.$("#constraintList-select2").on('select2-removing', function (e) {
                if (e.choice.text === "Bütçe"){
                    $("#butceInput").val("");
                    $("#butceMiktari").css("color","black");
                    $("#butceInput").css("visibility", "hidden");
                    $("#butceLabel").css("visibility", "hidden");
                }
                else if (e.choice.text === "Başlangıç Tarihi"){
                    $("#baslangicTarihiInput").css("visibility", "hidden");
                    $("#baslangicTarihiLabel").css("visibility", "hidden");
                }
                else if (e.choice.text === "Bitiş Tarihi"){
                    $("#bitisTarihiInput").css("visibility", "hidden");
                    $("#bitisTarihiLabel").css("visibility", "hidden");
                }
            });

            // $("#baslangicTarihiInput").on("click", function() {

            function datePickerChanged(date){
                baslangicTarihiBoolean = true;
                bitisTarihiBoolean = true;
                selectedThisRows.forEach(selectedRow => {
                    var selectKey = selectedRow.children().first().children().text();
                    var baslangicKisit = $("#baslangicTarihiInput").val();
                    var bitisKisit = $("#bitisTarihiInput").val();
                    var baslangicKisitDate = Date.parse(baslangicKisit);
                    var bitisKisitDate = Date.parse(bitisKisit);
                    for (var i = 0; i < jsonDataTable.length; i++) {
                        if (jsonDataTable[i]['key'] === selectKey) {
                            if (isNaN(parseInt(jsonDataTable[i]['Bütçe']))) {
                                butceCount = selectedButce
                                alert("Lütfen Bütçe Alanını ekleyin")
                                $(this).removeClass('selected');

                            } else {
                                if (Object.keys(jsonDataTable[i]).includes("Başlangıç Tarihi")  ) {
                                    if (jsonDataTable[i]["Başlangıç Tarihi"] !== "-") {
                                        var issueBaslangicTarihiString = jsonDataTable[i]["Başlangıç Tarihi"];
                                        issueBaslangicTarihiString = issueBaslangicTarihiString.replaceAll("-", "/")
                                        issueBaslangicTarihiString = issueBaslangicTarihiString.replaceAll(".0", "")
                                        var issueBaslangicTarihiDate = Date.parse(issueBaslangicTarihiString);
                                        if(!isNaN(baslangicKisitDate)){
                                            if (issueBaslangicTarihiDate >= baslangicKisitDate) {
                                            } else {
                                                baslangicTarihiBoolean = false;
                                            }
                                        }
                                    }
                                }
                                if (Object.keys(jsonDataTable[i]).includes("Bitiş Tarihi")  ) {
                                    if (jsonDataTable[i]["Bitiş Tarihi"] !== "-") {
                                        var issueBitisTarihiString = jsonDataTable[i]["Bitiş Tarihi"];
                                        issueBitisTarihiString = issueBitisTarihiString.replaceAll("-", "/")
                                        issueBitisTarihiString = issueBitisTarihiString.replaceAll(".0", "")
                                        var issueBitisTarihiDate = Date.parse(issueBitisTarihiString);

                                        if(!isNaN(bitisKisitDate)){
                                            if (issueBitisTarihiDate < bitisKisitDate) {
                                            } else {
                                                bitisTarihiBoolean = false;
                                            }
                                        }
                                    }
                                }


                                butceCount += parseInt(jsonDataTable[i]['Bütçe'])
                                selectedButce = butceCount
                                selectedRows.push(selectKey)
                            }
                        }
                    }
                    if (baslangicTarihiBoolean){
                        if (bitisTarihiBoolean) {
                            $("#issueDurum").text("Olumlu");
                            $("#issueDurum").css("color", "green")
                        }
                        else {
                            $("#issueDurum").text("Olumsuz(Bitiş Tarihi Geçersiz)");
                            $("#issueDurum").css("color", "red")
                        }
                    }
                    else {
                        $("#issueDurum").text("Olumsuz(Başlangıç Tarihi Geçersiz)");
                        $("#issueDurum").css("color", "red")
                    }
                })
            }
            function datePickerFilter(date){

                console.log("-------datePickerFilter---------")
                var baslangicKisit = $("#baslangicTarihiInput").val();
                var bitisKisit = $("#bitisTarihiInput").val();

                var baslangicKisitDate = Date.parse(baslangicKisit);
                baslangicKisitDate=baslangicKisitDate/1000;

                var bitisKisitDate = Date.parse(bitisKisit);
                bitisKisitDate=bitisKisitDate/1000;

                for (var i = 0; i < jsonDataTable.length; i++) {

                    if (Object.keys(jsonDataTable[i]).includes("Başlangıç Tarihi") ) {
                        if (jsonDataTable[i]["Başlangıç Tarihi"] !== "-") {
                            var issueBaslangicTarihiString = jsonDataTable[i]["Başlangıç Tarihi"];
                            issueBaslangicTarihiString = issueBaslangicTarihiString.replaceAll("-", "/")
                            issueBaslangicTarihiString = issueBaslangicTarihiString.replaceAll(".0", "")
                            var issueBaslangicTarihiDate = Date.parse(issueBaslangicTarihiString);
                            issueBaslangicTarihiDate=issueBaslangicTarihiDate/1000;
                            console.log(" issueBaslangicTarihiDate: "+issueBaslangicTarihiDate)
                            console.log(" baslangicKisitDate: "+baslangicKisitDate)


                            if(!isNaN(baslangicKisitDate)){

                                if ( issueBaslangicTarihiDate >= baslangicKisitDate) {

                                    var tableBody = $('#tableBody tr');
                                    var keys=[]
                                    tableBody.each(function () {
                                        var cell = $(this)
                                        var issueKey = $(this).find("td .issueKey")
                                        keys.push(issueKey.text())
                                    })

                                    var flag=false;
                                    if (!keys.includes(jsonDataTable[i]["key"])){
                                        flag=true;
                                        console.log("flag: "+flag)
                                    }
                                    if(flag){
                                        console.log("flag true, push edilcek")

                                        jsonDataTable.forEach(data => {
                                            if (jsonDataTable[i]["key"]===(data.key)){
                                                console.log("eklenecek satır jsondatatable da bulundu")
                                                var rowArray=[]
                                                rowArray.push('<a href="$baseUrl/browse/' + data.key + '" ' + 'class="issueKey">' + data.key + '</a>');
                                                rowArray.push(data.Summary)
                                                rowArray.push(data.Description)
                                                rowArray.push(data.Priority)
                                                #foreach($cf in $customFieldsInProject)
                                                    rowArray.push('<td id="$cf.getId()" name="$cf.getId()"  style="display:none;" class="$cf.getId()">'+ data["$cf.getName()"] +'</td>')
                                                #end
                                                dataTable.row.add(rowArray).draw()

                                            }
                                        })

                                    }


                                } else {
                                    console.log("else -- silinecek  "+ jsonDataTable[i]["key"])
                                    var tableBody = $('#tableBody tr');
                                    tableBody.each(function () {
                                        var cell = $(this)
                                        var issueKey = $(this).find("td .issueKey")
                                        if (jsonDataTable[i]["key"] === issueKey.text()) {
                                            dataTable.row(cell).remove().draw();
                                        } else {
                                        }

                                    })
                                }
                            }
                            else{
                                console.log("date is not a number")
                            }

                        }

                    }

                    if (Object.keys(jsonDataTable[i]).includes("Bitiş Tarihi") ) {
                        if (jsonDataTable[i]["Bitiş Tarihi"] !== "-") {
                            var issueBitisTarihiString = jsonDataTable[i]["Bitiş Tarihi"];
                            issueBitisTarihiString = issueBitisTarihiString.replaceAll("-", "/")
                            issueBitisTarihiString = issueBitisTarihiString.replaceAll(".0", "")
                            var issueBitisTarihiDate = Date.parse(issueBitisTarihiString);
                            issueBitisTarihiDate=issueBitisTarihiDate/1000;

                            if(!isNaN(bitisKisitDate)){

                                if($("#baslangicTarihiInput").val() == "") {
                                    if ( issueBitisTarihiDate <= bitisKisitDate) {

                                        var tableBody = $('#tableBody tr');
                                        var keys=[]
                                        tableBody.each(function () {
                                            var cell = $(this)
                                            var issueKey = $(this).find("td .issueKey")
                                            keys.push(issueKey.text())
                                        })

                                        var flag=false;
                                        if (!keys.includes(jsonDataTable[i]["key"])){
                                            flag=true;
                                            console.log("flag: "+flag)
                                        }
                                        if(flag){

                                            jsonDataTable.forEach(data => {
                                                if (jsonDataTable[i]["key"]===(data.key)){
                                                    console.log("eklenecek satır jsondatatable da bulundu")
                                                    var rowArray=[]
                                                    rowArray.push('<a href="$baseUrl/browse/' + data.key + '" ' + 'class="issueKey">' + data.key + '</a>');
                                                    rowArray.push(data.Summary)
                                                    rowArray.push(data.Description)
                                                    rowArray.push(data.Priority)
                                                    #foreach($cf in $customFieldsInProject)
                                                        rowArray.push('<td id="$cf.getId()" name="$cf.getId()"  style="display:none;" class="$cf.getId()">'+ data["$cf.getName()"] +'</td>')
                                                    #end
                                                    dataTable.row.add(rowArray).draw()
                                                }
                                            })

                                        }


                                    }
                                    else {
                                        console.log("else -- silinecek  "+ jsonDataTable[i]["key"])
                                        var tableBody = $('#tableBody tr');
                                        tableBody.each(function () {
                                            var cell = $(this)
                                            var issueKey = $(this).find("td .issueKey")
                                            if (jsonDataTable[i]["key"] === issueKey.text()) {
                                                dataTable.row(cell).remove().draw();
                                            } else {
                                            }

                                        })
                                    }
                                }else {
                                    if ( issueBitisTarihiDate <= bitisKisitDate) {

                                    }else{
                                        console.log("else -- silinecek  "+ jsonDataTable[i]["key"])
                                        var tableBody = $('#tableBody tr');
                                        tableBody.each(function () {
                                            var cell = $(this)
                                            var issueKey = $(this).find("td .issueKey")
                                            if (jsonDataTable[i]["key"] === issueKey.text()) {
                                                dataTable.row(cell).remove().draw();
                                            } else {
                                            }

                                        })
                                    }
                                }


                            }else{
                                console.log("date is not a number")
                            }

                        }
                    }

                }

            }


            AJS.$('#temizleButton').on( 'click', function () {
                $("tr").removeClass("selected");
                $("#butceMiktari").removeClass("blink");
                selectedRows=[];
                butceCount=0;

                $("#butceMiktari").text(butceCount).css("color","black");
                $("#issueDurum").text("").css("color","black");

            });


            function updatePrioritiesInJIRA(gmyOrBirim) {
                var table = $('#auiTable').tableToJSON({
                    ignoreEmptyRows : true,
                    onlyColumns: [0,1]
                    //Bu sıralama önemli
                }); // Convert the table into a javascript object

                var priority = "$Priority";


                jQuery.ajax({
                    url: AJS.params.baseURL + "/rest/florestservice/1.2/rest/setPriorityCfValuesInJira",
                    type: 'POST',
                    data: {
                        jsontable: JSON.stringify(table),
                        gmyOrBirim : gmyOrBirim
                    },
                    async: true,
                    beforeSend: function () {
                        console.log("234 beforeSend")
                    },
                    complete: function (response) {
                        console.log("234 complete")
                    },
                    error: function (response) {
                        console.log("setPriorityCfValuesInJira has finished with ERROR !!!");
                    },
                    success: function (response, status, jqXHR) {
                        console.log("setPriorityCfValuesInJira is successful");
                        window.location.reload();
                    }
                });
            }
            function bulkGetCfValuesFromIssue(issueKeys, customfieldId){
                var value="-";
                jQuery.ajax({
                    url: AJS.params.baseURL + "/rest/florestservice/1.2/rest/bulkGetCfValueFromIssue",
                    type: 'POST',
                    data: {
                        issueKey: issueKeys,
                        customFieldId: customfieldId
                    },
                    async: false,
                    beforeSend: function () {
                        console.log("178 beforeSend")
                    },
                    error : function (response) {
                        value= "-";
                    },
                    success: function (response, status, jqXHR) {
                        console.log("getCfValueFromIssue complete");
                        window.scrollTo({
                            left: 20000,top: 300,
                            behavior: 'smooth',
                        });
                        value= response;
                    }
                });
                return value;
            }
            function updatePriorities(restriction) {
                var i = 0;
                var tableBody = AJS.$('#tableBody > tr');
                tableBody.each(function () {
                    if (restriction === "gmy") {
                        AJS.$(this).find(".gmyPriority").text(i + 1);
                    } else if (restriction === "dp") {
                        AJS.$(this).find(".birimOncelik").text(i + 1);
                    }else {
                        AJS.$(this).find(".birimOncelik").text(i + 1);
                        AJS.$(this).find(".gmyPriority").text(i + 1);
                    }
                    i++;
                });
                console.log("Priorities are updated (Not in JIRA DB))");
            }


        });
    </script>


</head>
<body>
    #if( $issues.isEmpty() )
    <div class="aui-group">
        <div class="aui-help aui-help-empty-state">
            <div class="aui-help-content">
                <h1>Proje Önceliklendirme</h1>
                <p>Önceliklendirme yapılacak proje bulunamadı.</p>
            </div>
        </div>
    </div>
    #else
    <div class="aui-group">
        <div class="aui-help aui-help-empty-state">
            <div class="aui-help-content">
                <h1>Proje Önceliklendirme</h1>
                <p>Projeleri sürekle-bırak yöntemi ile istediğiniz sıraya taşıyınız. Önceliklendirme bittikten sonra kaydet tuşuna basınız. Bütçe kısıtını belirlemek için öncelikle kısıt alanı ekleyerek belirlediğiniz bütçe değerini girin.</p>
            </div>
        </div>
    </div>



    <div>
        <div class="row">
            <div class="col-xs-6 col-md-4">
                <div class="aui-group">
                    <div class="aui-item" id="#select2-customFields">
                        <form class="aui">
                            <select id="customFieldList-select2" data-placeholder="Alan eklemek için tıklayın" multiple>
                                <option></option>
                                #foreach($cf in $customFieldsInProject)
                                    <option value="$cf.getId()">$cf.getName()</option>
                                #end
##                                <option id="projectLeader" name="projectLeader" value="projectLeader">Proje Lideri</option>
                            </select>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-xs-6 col-md-4">
                <div class="aui-group">
                    <div class="aui-item" id="#select2-favFilters">
                        <form class="aui">
                            <select id="favFilter-select2" data-placeholder="Filtre eklemek için tıklayın" size="1">
                                <option>Bir seçenek seçin</option>
                                #foreach($favFilter in $favouriteFilters)
                                    <option value="$favFilter">$favFilter</option>
                                #end
                            </select>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-10 col-md-8">
                <div class="aui-group">
                    <div class="aui-item" id="#select2-constraint">
                        <form class="aui">
                            <select id="constraintList-select2" data-placeholder="Kısıt eklemek için tıklayın" multiple>
                                <option></option>
                                <option value="butce">Bütçe</option>
                                <option value="baslangicTarihi">Başlangıç Tarihi</option>
                                <option value="bitisTarihi">Bitiş Tarihi</option>
                            </select>
                            <form>
                                <div class="col-xs-6 col-md-4">
                                    <label for="butceInput" id="butceLabel" name="butceLabel" style="visibility: hidden;">Bütçe:</label>
                                    <input type="text" id="butceInput" name="butceInput" style="visibility: hidden;">
                                </div>
                                <div class="col-xs-6 col-md-4">
                                    <label for="baslangicTarihiInput" id="baslangicTarihiLabel" name="baslangicTarihiLabel" style="visibility: hidden;">Başlangıç Tarihi:</label>
                                    <input id="baslangicTarihiInput" name="baslangicTarihiInput" class="aui-date-picker" id="demo-range-1" type="date" style="visibility: hidden;"/>
                                </div>
                                <div class="col-xs-6 col-md-4">
                                    <label for="bitisTarihiInput" id="bitisTarihiLabel" name="bitisTarihiLabel" style="visibility: hidden;">Bitiş Tarihi:</label>
                                    <input id="bitisTarihiInput" name="bitisTarihiInput" class="aui-date-picker" id="demo-range-1" type="date" style="visibility: hidden;"/>
                                </div>
                            </form>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="aui-group">
        <div id="loading-spinner" class="custom-card-style">
            <p>Loading results...</p>
            <aui-spinner size="large"></aui-spinner>
        </div>
    </div>


    <div class="row" style="margin-top:50px;">

        <div class="col-xs-6 col-md-1">
            <div class="aui-group" id="buttons">
                <button class="aui-button aui-button-primary" id="kaydetButton">Sıralamayı Kaydet</button>
            </div>
        </div>
        <div class="col-xs-6 col-md-1" style="padding-left:60px">
            <div class="aui-group" id="buttons">
                <button class="aui-button" id="temizleButton">Seçimi Temizle</button>
            </div>
        </div>
        <div class="col-xs-6 col-md-1" style="padding-left:80px">
            <div class="aui-group" id="buttons">
                <button class="aui-button" id="onaylaButton">Projeyi Onayla</button>
            </div>
        </div>
        <div>

##            <div style="float: right; padding-left: 20px; padding-right: 30px;">
##                <label style="display: inline">Tarih Geçerlilik Durumu: </label>
##                <!--<p id="issueDurum" style="display: inline"></p>-->
##                <aui-badge id="issueDurum" style="font-size: 14px; display: inline;"></aui-badge>
##            </div>
            <div style="float: right; padding-left: 60px; padding-right: 30px;">
                <label style="display: inline">Kaynak Durumu: </label>
                <aui-badge id="kaynak" style="font-size: 14px; display: inline;"></aui-badge>
            </div>

            <div style="float: right;">
                <label style="display:inline">Butce: </label>
                <!--<p id="butceMiktari" style="display:inline"></p>-->
                <aui-badge id="butceMiktari" style="font-size: 17px; display: inline;"></aui-badge>
            </div>
        </div>

    </div>

    <div class="aui-group list-group" id="tableDiv">
        <table class="aui aui-table-list" id="auiTable" >
            <thead>
                <tr id="tableHeader">
                    <th class="aui-table-column-issue-key" data-override="key"  id="row1">Kayıt Anahtarı</th>
                    <th data-override="Summary" style="font-weight:bold;" id="row1">Özet</th>
                    <th class="aui-table-column-unsortable" data-override="Description"  id="row1">Açıklama</th>
                    <th class="aui-table-column-priority" data-override="Priority"  id="row1">Öncelik</th>
##                    <th class="aui-table-column-unsortable" data-override="Created" id="row1">Oluşturulma Tarihi</th>
##                    <th class="aui-table-column-unsortable" data-override="Due" id="row1">Bitiş Tarihi</th>
                    #foreach($cf in $customFieldsInProject)
                        <th style="font-weight: bold;" data-override="$cf.getId()">$cf.getName()</th>
                    #end
##                    <th style="font-weight: bold;" data-override="Lead" id="row1">Proje Lideri</th>
                </tr>
            </thead>

            <tbody id="tableBody">
                #foreach( $issue in $issueList )
                <tr id="shadow" data-id="$issue.getSummary()">
                    <td id="issueKey" name="issueKey"><a href="$baseUrl/browse/$issue.getKey()" class="issueKey">$issue.getKey()</a></td>
                    <td id="issueSummary" name="issueSummary">$issue.getSummary()</td>
                    <td id="issueDescription" name="issueDescription" class="might-overflow">
                        #if ( !$issue.getDescription() )
                            -
                        #else
                            $issue.getDescription()
                        #end
                    </td>
##                    <td data-id="issuePriority" id="issuePriority" name="issuePriority" class="might-overflow">-</td>
                    <td id="issuePriority" name="issuePriority" class="might-overflow">-</td>
##                    <td id="issueCreated" name="issueCreated" class="might-overflow">$issue.getCreated()</td>
##                    <td id="issueDue" name="issueDue" class="might-overflow">
##                        #if ( !$issue.getDueDate() )
##                            -
##                        #else
##                            $issue.getDueDate()
##                        #end
##                    </td>
                    #foreach($cf in $customFieldsInProject)
##                        <td id="$cf.getId()" name="$cf.getId()"  style="display:none;" class="$cf.getId()">-</td>
                        <td id="$cf.getId()" name="$cf.getId()" class="$cf.getId()">-</td>
                    #end
##                    #foreach($lead in $projectLeadList)
##                        <td id="projectLeader" name="projectLeader">-</td>
##                    #end
                </tr>
                #end
            </tbody>
        </table>
    </div>

    <div class="gantt" name="gantt" id="gantt"></div>

    #end




</body>
</html>